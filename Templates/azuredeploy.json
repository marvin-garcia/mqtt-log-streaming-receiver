{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "location": {
        "type": "string",
        "defaultValue": "[resourceGroup().location]",
        "metadata": {
          "description": "Specifies the deployment location."
        }
      },
      "environmentHashId": {
        "type": "string",
        "metadata": {
          "description": "Unique alphanumeric id to assign to multiple resource names."
        }
      },
      "iotHubName": {
        "type": "string",
        "metadata": {
          "description": "Name for IoT Hub resource."
        }
      },
      "iotHubServicePolicyName": {
        "type": "string",
        "metadata": {
          "description": "IoT hub policy policy name."
        }
      },
      "iotHubSku": {
        "type": "string",
        "defaultValue": "S1",
        "allowedValues": [
          "F1",
          "S1",
          "S2",
          "S3"
        ],
        "metadata": {
          "description": "The Azure IoT Hub SKU to use."
        }
      },
      "iotHubCapacity": {
        "type": "int",
        "defaultValue": 1,
        "metadata": {
          "description": "The Azure IoT Hub SKU capacity to use."
        }
      },
      "iotHubTier": {
        "type": "string",
        "defaultValue": "Standard",
        "allowedValues": [
          "Free",
          "Standard"
        ],
        "metadata": {
          "description": "The Azure IoT Hub tier to use."
        }
      },
      "iotHubPartitionCount": {
        "type": "int",
        "defaultValue": 4,
        "metadata": {
          "description": "The Azure IoT Hub default endpoint partition count."
        }
      },
      "iotHubRetentionInDays": {
        "type": "int",
        "defaultValue": 2,
        "metadata": {
          "description": "The Azure IoT Hub default message retention in days."
        }
      },
      "vnetName": {
        "type": "string",
        "defaultValue": "[concat('iot-vnet-', parameters('environmentHashId'))]",
        "metadata": {
          "description": "Name for the virtual network."
        }
      },
      "vnetAddressPrefix": {
        "type": "string",
        "defaultValue": "10.0.0.0/16",
        "metadata": {
          "description": "Address prefix for the virtual network."
        }
      },
      "edgeSubnetName": {
        "type": "string",
        "defaultValue": "iotedge",
        "metadata": {
          "description": "Name for the IoT edge VM subnet."
        }
      },
      "edgeSubnetAddressRange": {
        "type": "string",
        "defaultValue": "10.0.0.0/24",
        "metadata": {
          "description": "Address range for the IoT edge VM subnet."
        }
      },
      "edgeVmName": {
        "type": "string",
        "defaultValue": "[concat('iotedgevm-', parameters('environmentHashId'))]",
        "metadata": {
          "description": "IoT edge virtual machine name."
        }
      },
      "edgeVmSize": {
        "type": "string",
        "defaultValue": "Standard_D2s_v3",
        "metadata": {
          "description": "IoT edge virtual machine size."
        }
      },
      "adminUsername": {
        "type": "string",
        "defaultValue": "azureuser",
        "metadata": {
          "description": "Specifies a username for the Virtual Machine."
        }
      },
      "adminPassword": {
        "type": "secureString",
        "defaultValue": "",
        "metadata": {
          "description": "Specifies the username password for the Virtual Machine."
        }
      },
      "storageAccountName": {
        "type": "string",
        "metadata": {
          "description": "Logs storage account name."
        }
      },
      "storageContainerName": {
        "type": "string",
        "metadata": {
          "description": "Logs storage container name."
        }
      },
      "storageAccountSku": {
        "type": "string",
        "defaultValue": "Standard_LRS",
        "allowedValues": [
          "Standard_LRS",
          "Standard_GRS",
          "Standard_RAGRS",
          "Standard_ZRS",
          "Premium_LRS"
        ],
        "metadata": {
          "description": "Logs storage account SKU."
        }
      },
      "workspaceName": {
        "type": "string",
        "metadata": {
          "description": "Log analytics Workspace name."
        }
      },
      "workspaceSku": {
        "type": "string",
        "defaultValue": "PerGB2018",
        "allowedValues": [
          "Free",
          "Standard",
          "Premium",
          "PerNode",
          "PerGB2018",
          "Standalone",
          "CapacityReservation"
        ],
        "metadata": {
          "description": "Log analytics Workspace name."
        }
      },
      "templateUrl": {
        "type": "string",
        "metadata": {
          "description": "GitHub repo URL."
        }
      },
      "branchName": {
        "type": "string",
        "defaultValue": "main",
        "metadata": {
          "description": "GitHub repo branch name."
        }
      }
    },
  "variables": {
    "iotHubOwnerPolicyName": "iothubowner",
    "edgeVmDnsName": "[concat(parameters('edgeVmName'))]",
    "workspaceId": "[resourceId(resourceGroup().name, 'Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]",
    "workspaceApiVersion": "[providers('microsoft.operationalinsights', 'workspaces').apiVersions[0]]",
    "iotHubDeploymentName": "[concat('iothub-', parameters('environmentHashId'))]",
    "iotHubDeploymentTemplate": "[concat(parameters('templateUrl'), '/', parameters('branchName'), '/Templates/iothub-deploy.json')]",
    "iotEdgeDeploymentName": "[concat('iotedge-', parameters('environmentHashId'))]",
    "iotEdgeDeploymentTemplate": "[concat(parameters('templateUrl'), '/', parameters('branchName'), '/Templates/iotedge-vm-deploy.json')]",
    "storageAccountDeploymentName": "[concat('storageaccount-', parameters('environmentHashId'))]",
    "storageAccountDeploymentTemplate": "[concat(parameters('templateUrl'), '/', parameters('branchName'), '/Templates/storage-deploy.json')]",
    "linkedDeploymentApiVersion": "2020-10-01"
  },
    "resources": [
      {
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "[variables('linkedDeploymentApiVersion')]",
        "name": "[variables('iotHubDeploymentName')]",
        "resourceGroup": "[resourceGroup().name]",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "contentVersion": "1.0.0.0",
            "uri": "[variables('iotHubDeploymentTemplate')]"
          },
          "parameters": {
            "location": {
              "value": "[parameters('location')]"
            },
            "iotHubName": {
              "value": "[parameters('iotHubName')]"
            },
            "iotHubSku": {
              "value": "[parameters('iotHubSku')]"
            },
            "iotHubTier": {
              "value": "[parameters('iotHubTier')]"
            },
            "iotHubCapacity": {
              "value": "[parameters('iotHubCapacity')]"
            },
            "iotHubRetentionInDays": {
              "value": "[parameters('iotHubRetentionInDays')]"
            },
            "iotHubPartitionCount": {
              "value": "[parameters('iotHubPartitionCount')]"
            },            
            "iotHubOwnerPolicyName": {
              "value": "[variables('iotHubOwnerPolicyName')]"
            },
            "iotHubServicePolicyName": {
              "value": "[parameters('iotHubServicePolicyName')]"
            }
          }
        }
      },
      {
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "[variables('linkedDeploymentApiVersion')]",
        "name": "[variables('iotEdgeDeploymentName')]",
        "resourceGroup": "[resourceGroup().name]",
        "dependsOn": [
          "[concat('Microsoft.Resources/deployments/', variables('iotHubDeploymentName'))]"
        ],
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "contentVersion": "1.0.0.0",
            "uri": "[variables('iotEdgeDeploymentTemplate')]"
          },
          "parameters": {
            "location": {
              "value": "[parameters('location')]"
            },
            "edgeVmName": {
              "value": "[parameters('edgeVmName')]"
            },
            "edgeVmDnsName": {
              "value": "[variables('edgeVmDnsName')]"
            },
            "edgeVmSize": {
              "value": "[parameters('edgeVmSize')]"
            },
            "adminUsername": {
              "value": "[parameters('adminUsername')]"
            },
            "adminPassword": {
              "value": "[parameters('adminPassword')]"
            },
            "vnetName": {
              "value": "[parameters('vnetName')]"
            },
            "vnetAddressPrefix": {
              "value": "[parameters('vnetAddressPrefix')]"
            },
            "edgeSubnetName": {
              "value": "[parameters('edgeSubnetName')]"
            },
            "edgeSubnetAddressRange": {
              "value": "[parameters('edgeSubnetAddressRange')]"
            }
          }
        }
      },
      {
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "[variables('linkedDeploymentApiVersion')]",
        "name": "[variables('storageAccountDeploymentName')]",
        "resourceGroup": "[resourceGroup().name]",
        "dependsOn": [],
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "contentVersion": "1.0.0.0",
            "uri": "[variables('storageAccountDeploymentTemplate')]"
          },
          "parameters": {
            "location": {
              "value": "[parameters('location')]"
            },
            "storageAccountName": {
              "value": "[parameters('storageAccountName')]"
            },
            "storageAccountSku": {
              "value": "[parameters('storageAccountSku')]"
            },
            "storageContainerName": {
              "value": "[parameters('storageContainerName')]"
            }
          }
        }
      },
      {
        "apiVersion": "[variables('linkedDeploymentApiVersion')]",
        "type": "microsoft.operationalinsights/workspaces",
        "name": "[parameters('workspaceName')]",
        "location": "[parameters('location')]",
        "properties": {
          "sku": {
            "name": "[parameters('workspaceSku')]"
          },
          "retentionInDays": 30,
          "workspaceCapping": {
            "dailyQuotaGb": -1
          },
          "publicNetworkAccessForIngestion": "Enabled",
          "publicNetworkAccessForQuery": "Enabled"
        }
      }
    ],
    "outputs": {
      "iotHubResourceId": {
        "type": "string",
        "value": "[reference(variables('iotHubDeploymentName'), variables('linkedDeploymentApiVersion')).outputs.resourceId.value]"
      },
      "workspaceId": {
        "type": "string",
        "value": "[reference(variables('workspaceId'), variables('workspaceApiVersion')).customerId]"
      },
      "workspaceSharedKey": {
        "type": "string",
        "value": "[listKeys(variables('workspaceId'), variables('workspaceApiVersion')).primarySharedKey]"
      }
    }
  }